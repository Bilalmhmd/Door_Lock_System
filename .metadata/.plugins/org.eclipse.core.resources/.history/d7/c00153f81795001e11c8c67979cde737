/*
 * main.c
 *
 *  Created on: Dec 7, 2023
 *      Author: Bilal Mohamed
 */


#include "../HAL/lcd.h"
#include "../HAL/keypad.h"
#include "../MCAL/UART.h"
#include "../MCAL/TIMER1.h"
#include <avr/io.h>

/* ========================================================
 * 					* NOTES*
 * 1. Using Switch-statment instead of if-statment give me some of speed and decrease CPU load
 * 2. Enter button -- '='
 * ========================================================*/

/************************************************************************
 * 						Global static variable used in ISR timer1
 **************************************************************************/
static volatile uint8 g_tick =0;

void main(void)
{
	SREG|=(1<<7);	/* Enable i-bit*/

	/***********************************************
	 * 				UART Configurations
	 * 1.Even Parity
	 * 2.stop bit --onebit
	 * 3.8 bits Data
	 * 4.Baudrate= 9600
	 ***********************************************/
	UART_ConfigType configurations = { Eight_bits, Even_Parity , One_bit , 9600 };
	UART_init( &configurations);

	/* Initialize the LCD */
	LCD_init();

	/* agreement(sink) between Two ECUs*/
	UART_sendByte(MC2_GET_READY);

	LCD_displayString("Plz enter Pass: ");
	LCD_moveCursor(1, 0); /* Move the cursor to the next line*/


	while(1)
	{
		/* Get first step in system */
		insertNewPassword();
	}
}

/*
 * Function Name: insertNewPassword()
 * Description : Take a new Pass from user and Check it
 */
void insertNewPassword(void)
{
	key = KEYPAD_getPressedKey();
	switch(key)
	{
	case 0:
	case 1:
	case 2:
	case 3:
	case 4:
	case 5:
	case 6:
	case 7:
	case 8:
	case 9:
		switch(numOfPass_flag)
		{
		case 0:
		case 1:
		case 2:
		case 3:
		case 4:
			UART_sendByte(key);
			LCD_integerToString(key);
			_delay_ms(300);
			LCD_sendCommand(0x10);
			LCD_displayCharacter('*');
			numOfPass_flag ++;				/* Num of digits for password*/
			break;
		}

		break;
		case '=':
			/***************************************************
			 * 	Check that user insert pass from  five digits
			 ***************************************************/
			if(numOfPass_flag  != 0 && numOfPass_flag % 5 == 0 )
			{
				equality_flag++;			/* Increment num of '=' refer to enter button*/
				switch(equality_flag)
				{
				/* for enter first '='*/
				case 1:
					UART_sendByte(key);
					numOfPass_flag=0;
					LCD_sendCommand(LCD_CLEAR_COMMAND);
					LCD_displayStringRowColumn(0,0,"plz re-enter the");
					LCD_displayStringRowColumn(1,0,"same pass:");
					break;
					/*For enter second enter*/
				case 2:
					UART_sendByte(key);
					numOfPass_flag=0;
					equality_flag=-1;
					recieveCheckingPass();		 /* Function take checking from control_ECU*/
					break;
				}
			}

			break;
	}
	_delay_ms(300);  /* Press time */
}
